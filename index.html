<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Chat — Lucía (restauração otimizada)</title>
  <style>
    :root{
      --green: #25d366;
      --dark:  #075E54;
      --bg:    #eaf7ee;
      --msg-bg:#e5ddd5;
      --bubble:#ffffff;
      --muted: #7a7a7a;
    }

    html,body{height:100%;margin:0;font-family:Inter, Arial, Helvetica, sans-serif;background:linear-gradient(180deg,var(--bg) 0%, #f6f7f6 100%);}
    .app{width:100vw;max-width:460px;height:100vh;margin:0 auto;border-radius:12px;box-shadow:0 4px 12px rgba(30,40,40,0.1);overflow:hidden;display:flex;flex-direction:column;background:linear-gradient(180deg,#f3efec 0%, #efe8e3 100%);}

    .header{flex-shrink:0;height:56px;padding:8px 12px;background:var(--dark);color:#fff;display:flex;align-items:center;gap:10px;}
    .avatar{width:40px;height:40px;border-radius:50%;background-size:cover;background-position:center;border:2px solid rgba(255,255,255,0.15);flex-shrink:0;}
    .meta{display:flex;flex-direction:column;min-width:0}
    .meta strong{font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .meta .status{font-size:12px;display:flex;align-items:center;gap:4px;opacity:0.95}
    .status .dot{width:7px;height:7px;border-radius:50%;background:var(--green);box-shadow:0 0 4px rgba(37,211,102,0.2)}

    .messages{flex:1;min-height:0;padding:16px 14px;background:var(--msg-bg);display:flex;flex-direction:column;gap:14px;overflow-y:auto;-webkit-overflow-scrolling:touch;}
    .messages::-webkit-scrollbar{display:none} .messages{ -ms-overflow-style:none; scrollbar-width:none }

    .bubble{background:var(--bubble);padding:12px;border-radius:10px;max-width:86%;align-self:flex-start;box-shadow:0 1px 3px rgba(0,0,0,0.06);position:relative;overflow-wrap:break-word;animation:appear .18s ease;}

    .audio-bubble{display:flex;align-items:center;gap:10px;width:100%;box-sizing:border-box;padding:2px 0;}
    .audio-play-btn{
      width:28px;
      height:28px;
      border-radius:50%;
      background:#fff;
      border:2px solid var(--green);
      color:var(--green);
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      padding:0;
      flex-shrink:0;
      transition: background .12s, color .12s, transform .06s;
    }
    .audio-play-btn:active{ transform: scale(.98); }
    .audio-play-btn.playing{ background:var(--green); color:#fff; border-color:transparent; }

    .audio-track{ flex:1; height:6px; background:#eee; border-radius:6px; overflow:hidden; position:relative; cursor:pointer; min-width:clamp(140px, 50vw, 240px); tabindex:0; }
    .audio-progress{ position:absolute; left:0; top:0; bottom:0; width:0%; background:var(--dark); border-radius:6px; transition: width 0.1s linear; }

    .audio-time{ width:52px; text-align:right; font-size:12px; color:#555; flex-shrink:0; margin-left:6px; }

    audio.native-audio{ display:none; }

    .bubble video{ width:100%; border-radius:8px; display:block; }
    .timestamp{ font-size:11px; color:var(--muted); margin-top:6px; text-align:right; }

    .loading-bubble{display:flex;align-items:center;gap:4px;height:20px; aria-label="Carregando mensagem";}
    .loading-bubble .dot{width:6px;height:6px;border-radius:50%;background:#999;animation:bounce 1.2s infinite;}
    .loading-bubble .dot:nth-child(2){animation-delay:0.2s} .loading-bubble .dot:nth-child(3){animation-delay:0.4s}
    @keyframes bounce{0%,80%,100%{transform:scale(0.6);opacity:0.6}40%{transform:scale(1);opacity:1}}

    @keyframes appear{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}

    @media (max-width:360px){
      .audio-time{ width:44px; font-size:11px; }
    }

    .audio-play-btn:focus, .audio-track:focus{ outline:3px solid rgba(7,94,84,0.15); outline-offset:3px; }

    .error-msg { color: red; font-size: 12px; margin-top: 4px; }
  </style>
</head>
<body>
  <div class="app" role="main" aria-label="Chat com Lucía">
    <div class="header">
      <div id="avatar" class="avatar" style="background-image:url('https://i.pravatar.cc/150?img=47')"></div>
      <div class="meta">
        <strong id="chatName">Lucía</strong>
        <div class="status"><span class="dot" aria-hidden="true"></span><span>online</span></div>
      </div>
    </div>
    <div class="messages" id="messages" aria-live="polite"></div>
  </div>

  <script>
    const M = {
      avatar: 'https://i.pravatar.cc/150?img=47',
      audioUrl: 'https://s3-cf.zapsafe.work/gnn/audio3.mp3',
      videoUrl: 'https://s3-cf.zapsafe.work/gnn/45.mp4',
      maxLoadTimeout: 10000 // Fallback timeout em ms
    };

    const msgs = document.getElementById('messages');
    document.getElementById('avatar').style.backgroundImage = `url(${M.avatar})`;

    function fmtTime(){
      const d = new Date();
      return String(d.getHours()).padStart(2,'0') + ':' + String(d.getMinutes()).padStart(2,'0');
    }
    function fmtTimeSec(sec){
      if (!isFinite(sec) || sec < 0) return '0:00';
      const m = Math.floor(sec / 60);
      const s = Math.floor(sec % 60).toString().padStart(2,'0');
      return `${m}:${s}`;
    }

    function addBubble(html){
      const b = document.createElement('div');
      b.className = 'bubble';
      b.innerHTML = html;
      msgs.appendChild(b);
      msgs.scrollTop = msgs.scrollHeight;
      return b;
    }

    function ensureVisible(){ 
      msgs.scrollTop = msgs.scrollHeight; 
    }

    function setupAudioControls(audio, playBtn, track, progress, timeEl, bubble) {
      const SVG_PLAY = `<svg viewBox="0 0 24 24" width="14" height="14" fill="currentColor" aria-hidden="true"><path d="M8 5v14l11-7z"/></svg>`;
      const SVG_PAUSE = `<svg viewBox="0 0 24 24" width="14" height="14" fill="currentColor" aria-hidden="true"><path d="M6 19h4V5H6zm8-14v14h4V5z"/></svg>`;

      playBtn.addEventListener('click', () => {
        if (audio.paused) audio.play().catch(handleError); 
        else audio.pause();
      });

      playBtn.addEventListener('keydown', (e) => {
        if (e.code === 'Space') e.preventDefault();
      });

      audio.addEventListener('play', () => {
        playBtn.classList.add('playing');
        playBtn.innerHTML = SVG_PAUSE;
        playBtn.setAttribute('aria-label', 'Pausar');
        playBtn.setAttribute('title', 'Pausar');
        ensureVisible();
      });
      audio.addEventListener('pause', () => updatePauseState());
      audio.addEventListener('ended', () => updatePauseState());

      function updatePauseState() {
        playBtn.classList.remove('playing');
        playBtn.innerHTML = SVG_PLAY;
        playBtn.setAttribute('aria-label', 'Tocar');
        playBtn.setAttribute('title', 'Tocar');
      }

      audio.addEventListener('timeupdate', () => {
        if (!audio.duration) return;
        const pct = (audio.currentTime / audio.duration) * 100;
        progress.style.width = `${pct}%`;
        timeEl.textContent = fmtTimeSec(audio.currentTime);
        track.setAttribute('aria-valuenow', Math.floor(pct));
      });

      function seekAudio(ev) {
        if (!audio.duration) return;
        const rect = track.getBoundingClientRect();
        const x = ev.clientX - rect.left || ev.touches[0].clientX - rect.left;
        audio.currentTime = (x / rect.width) * audio.duration;
      }
      track.addEventListener('click', seekAudio);
      track.addEventListener('touchstart', seekAudio); // Suporte a touch
      track.addEventListener('keydown', (e) => {
        if (e.code === 'Enter' || e.code === 'Space') {
          e.preventDefault();
          // Simular seek no centro para teclado (ou implementar setas)
          audio.currentTime = (audio.duration / 2);
        }
      });

      audio.addEventListener('error', () => handleError('Erro ao carregar áudio'));
      function handleError(msg = 'Erro inesperado') {
        bubble.innerHTML += `<div class="error-msg" role="alert">${msg}</div>`;
        playBtn.disabled = true;
      }

      ensureVisible();
    }

    async function loadMediaWithPlaceholder(createPlaceholder, loadEvent, url, setupFn, errorMsg) {
      const placeholder = addBubble(createPlaceholder());
      let resolved = false;

      const timeout = setTimeout(() => {
        if (!resolved) placeholder.innerHTML += `<div class="error-msg" role="alert">Tempo de carregamento excedido</div>`;
      }, M.maxLoadTimeout);

      const media = document.createElement(loadEvent === 'canplaythrough' ? 'audio' : 'video');
      media.src = url;
      media.preload = 'metadata';
      media.addEventListener(loadEvent, () => {
        if (resolved) return;
        resolved = true;
        clearTimeout(timeout);
        setupFn(placeholder, media);
      });
      media.addEventListener('error', () => {
        resolved = true;
        clearTimeout(timeout);
        placeholder.innerHTML += `<div class="error-msg" role="alert">${errorMsg}</div>`;
      });
      // Iniciar carregamento
      media.load();
    }

    async function run(){
      // Áudio
      await loadMediaWithPlaceholder(
        () => `<div class="loading-bubble"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>`,
        'canplaythrough',
        M.audioUrl,
        (bubble, audio) => {
          bubble.innerHTML = `
            <div class="audio-bubble" role="group" aria-label="Mensagem de áudio" aria-describedby="audio-desc">
              <button class="audio-play-btn" aria-label="Tocar" title="Tocar" type="button">
                ${/* SVG_PLAY inline */'<svg viewBox="0 0 24 24" width="14" height="14" fill="currentColor" aria-hidden="true"><path d="M8 5v14l11-7z"/></svg>'}
              </button>
              <div class="audio-track" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0" aria-label="Progresso do áudio">
                <div class="audio-progress"></div>
              </div>
              <div class="audio-time">0:00</div>
            </div>
            <audio class="native-audio"></audio> <!-- Clonado depois -->
            <div class="timestamp">${fmtTime()}</div>
            <div id="audio-desc" hidden>Mensagem de áudio de Lucía</div>
          `;
          const playBtn = bubble.querySelector('.audio-play-btn');
          const track = bubble.querySelector('.audio-track');
          const progress = bubble.querySelector('.audio-progress');
          const timeEl = bubble.querySelector('.audio-time');
          bubble.querySelector('audio').replaceWith(audio); // Inserir o áudio carregado
          setupAudioControls(audio, playBtn, track, progress, timeEl, bubble);
        },
        'Erro ao carregar áudio'
      );

      // Vídeo (similar, mas mais simples)
      await loadMediaWithPlaceholder(
        () => `<div class="loading-bubble"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>`,
        'loadedmetadata', // Para vídeo, usa loadedmetadata ou canplay
        M.videoUrl,
        (bubble, video) => {
          video.controls = true;
          video.playsInline = true;
          video.style.width = '100%';
          video.style.borderRadius = '8px';
          bubble.innerHTML = '';
          bubble.appendChild(video);
          bubble.innerHTML += `<div class="timestamp">${fmtTime()}</div>`;
        },
        'Erro ao carregar vídeo'
      );
    }

    window.addEventListener('load', run);
  </script>
</body>
</html>